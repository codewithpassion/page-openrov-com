"use strict";function _asyncToGenerator(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,r){function a(n,i){try{var o=e[n](i),s=o.value}catch(t){return void r(t)}if(!o.done)return Promise.resolve(s).then(function(t){a("next",t)},function(t){a("throw",t)});t(s)}return a("next")})}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function objectifyForm(t){for(var e={},r=0;r<t.length;r++)e[t[r].name]=t[r].value;return e}var _createClass=function(){function t(t,e){for(var r=0;r<e.length;r++){var a=e[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,r,a){return r&&t(e.prototype,r),a&&t(e,a),e}}(),PRODUCT="57e9bd02726ecc1100f4204a",BuyScreen=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"getData",value:function(t,e){var r={first_name:t.firstName,last_name:t.lastName,company:null,line1:t.address1,line2:t.address2,city:t.city,state:"US"===t.country?t.usState:t.state,zip:t.zip,country:t.country.toLowerCase(),phone:t.phone};return{user_id:"5637c8d966e9ec03008989ef",buyer:{email:t.email,first_name:t.firstName,last_name:t.lastName,phone:t.phone,notes:t.notes},shipping_address:r,billing_address:Object.assign({},r,{zip:t.billingZip}),line_items:[{product_id:PRODUCT,variant_id:e,quantity:parseInt(t.quantity)}],payment_source:{card:{name:t.firstName+" "+t.lastName,number:t.ccNumber,exp_month:t.expDate.split("/")[0],exp_year:t.expDate.split("/")[1],cvc:t.cvc}},discount_codes:[]}}},{key:"getVariant",value:function(t,e){var r=[];for(var a in t)a.startsWith("option_")&&r.push(t[a]);r=r.sort();var n=!0,i=!1,o=void 0;try{for(var s,c=e[Symbol.iterator]();!(n=(s=c.next()).done);n=!0){var u=s.value;if(u.options.ids.sort().join()===r.join())return u.id}}catch(t){i=!0,o=t}finally{try{!n&&c.return&&c.return()}finally{if(i)throw o}}}},{key:"calculateShipping",value:function(t,e){var r=objectifyForm(t.serializeArray()),a=this.getData(r,this.getVariant(t,e));return this._calculateShipping(a,t)}},{key:"_calculateShipping",value:function(){function t(t,r){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e,r){var a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r.find(".loading").show(),t.next=3,$.ajax({async:!0,crossDomain:!0,url:"https://wt-f938a32f745f3589d64a35c208dd4c79-0.run.webtask.io/celry-access/calculate-shipping",method:"POST",headers:{"content-type":"application/json"},processData:!1,data:JSON.stringify(e)});case 3:a=t.sent,r.find("#shipping").val("$"+(a.shipping/100).toFixed(2)),r.find("#subtotal").val("$"+(a.subtotal/100).toFixed(2)),r.find("#tax").val("$"+(a.taxes/100).toFixed(2)),r.find("#total").val("$"+(a.total/100).toFixed(2)),r.find(".loading").hide();case 9:case"end":return t.stop()}},t,this)}));return t}()},{key:"setupForm",value:function(){function t(t){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var r,a,n,i,o,s=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,$.ajax({url:"https://wt-f938a32f745f3589d64a35c208dd4c79-0.run.webtask.io/celry-access/products/"+PRODUCT});case 2:return r=t.sent,$("#description").html(r.data.description),a=r.data.options.map(function(t){return'<div class="form-group row"><label for="'+t.id+'" class="col-2 col-form-label">'+t.name+':</label><select class="form-control form-control-danger col-6" id="option_'+t.id+'" name="option_'+t.id+'" required><option selected value="" disabled>Select '+t.name+"</option>"+t.values.map(function(t){return'<option value="'+t.id+'">'+t.name+"</option>"}).join("")+"</select></div>"}).join(""),n=objectifyForm(e.serializeArray()),n.country="us",i=this.getData(n,r.data.variants[r.data.variants.length-1].id),this._calculateShipping(i,e),e.find("#options").append(a),e.find('#country option[value="US"]').attr("selected","true"),e.find("#country").change(function(t){"US"===t.currentTarget.options[t.target.selectedIndex].value?(e.find("#usState").removeClass("hidden-xs-up").attr("required",!1),e.find("#state").addClass("hidden-xs-up").attr("required",!0)):(e.find("#state").removeClass("hidden-xs-up").attr("required",!1),e.find("#usState").addClass("hidden-xs-up").attr("required",!1)),e.validator("update"),s.calculateShipping(e,r.data.variants)}),e.find("#options select").change(function(t){s.calculateShipping(e,r.data.variants)}),e.find("#quantity").change(function(t){s.calculateShipping(e,r.data.variants)}),e.find("#ccNumber").keypress(function(t){String.fromCharCode(t.which).match(/[0-9- ]/)||t.preventDefault()}),e.find("#expDate").keypress(function(t){String.fromCharCode(t.which).match(/[0-9\/]/)||t.preventDefault()}),e.on("validated.bs.validator",function(t){if("expDate"===t.relatedTarget.id){if(!t.relatedTarget.checkValidity())return $(t.relatedTarget).parent().addClass("has-danger"),!1;$(t.relatedTarget).parent().removeClass("has-danger")}}).on("invalid.bs.validator",function(t){console.log(t.relatedTarget.id+" "+t.detail)}),o=r.data.variants,t.abrupt("return",o);case 19:case"end":return t.stop()}},t,this)}));return t}()},{key:"submit",value:function(){function t(){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e,r,a,n,i,o,s,c,u,d;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=this.orderForm,r=this.variants,e.find('button[type="submit"]').attr("disabled",!0),e.find(".submitting").show(),a=objectifyForm(e.serializeArray()),n=this.getData(a,this.getVariant(a,this.getVariant(form,r))),t.prev=5,t.next=8,$.ajax({async:!0,crossDomain:!0,url:"https://api.trycelery.com/v2/orders/checkout",method:"POST",headers:{"content-type":"application/json"},processData:!1,data:JSON.stringify(n)});case 8:i=t.sent,o=i.data,s=o.total/100,c=o.currency,u=o.line_items.map(function(t){return t.celery_sku}).join(","),d="?number="+o.number+"&amount="+s+"&currency="+c+"&line_items="+u,window.location.replace(window.location.href+"../confirmation/"+d),t.next=23;break;case 17:t.prev=17,t.t0=t.catch(5),this.orderForm.find(".alert .title").text(t.t0.statusText),this.orderForm.find(".alert .description").text(t.t0.responseJSON.data),this.orderForm.find(".alert").show(),this.orderForm.find(".submitting").hide();case 23:case"end":return t.stop()}},t,this,[[5,17]])}));return t}()},{key:"runSetupForm",value:function(){function t(){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.setupForm(this.orderForm);case 2:this.variants=t.sent,this.orderForm.validator("update");case 4:case"end":return t.stop()}},t,this)}));return t}()},{key:"init",value:function(){var t=this;this.orderForm=$("form#orderForm");var e=this;this.orderForm.validator().find("button.submit").click(function(r){r.preventDefault(),void 0!==e.variants&&(t.orderForm.validator("validate"),e.orderForm[0].checkValidity()&&t.submit())}),$("#orderFormContainer").removeClass("invisible"),$("#loader-wrapper").addClass("loaded"),this.runSetupForm()}}]),t}();!function(){(new BuyScreen).init()}();